{{/* layouts/partials/projects.html */}}

{{ if .Site.Params.projects.enable | default false }}
<section id="projects" class="py-5">
  <div class="container">
    <h3 class="text-center">{{ .Site.Params.projects.title | default "Projects" }}</h3>

    {{/* Build unified project list */}}
    {{ $items := slice }}

    {{ range .Site.Params.projects.items }}
      {{ $items = $items | append (dict
        "title" .title
        "image" .image
        "badges" .badges
        "content" .content
        "links" .links
        "featured" .featured
      ) }}
    {{ end }}

    {{ range (where .Site.RegularPages "Type" "projects") }}
      {{ if .Params.showInHome | default true }}
        {{ $items = $items | append (dict
          "title" .Title
          "image" .Params.image
          "badges" .Params.badges
          "content" (.Summary | truncate 100 | safeHTML)
          "links" .Params.links
          "featured" (dict "name" "Know more" "link" .RelPermalink)
        ) }}
      {{ end }}
    {{ end }}

    {{ $total := len $items }}

    {{ if gt $total 0 }}
      {{ $carouselId := "projectsCarousel" }}

      <div id="{{ $carouselId }}" class="carousel slide" data-bs-ride="false">
        <div class="carousel-inner">

          {{/* One slide per project */}}
          {{ range $i, $_ := $items }}
            <div class="carousel-item {{ if eq $i 0 }}active{{ end }}">
              <div class="row justify-content-center px-3 px-md-5">

                {{/* Always show 3 cards, shift by 1 */}}
                {{ range $j := seq 0 2 }}
                  {{ $index := mod (add $i $j) $total }}
                  {{ $p := index $items $index }}

                  <div class="col-lg-4 col-md-6 my-3">
                    <div class="card my-3 h-100" title="{{ $p.title }}">
                      <div class="card-head">
                        <img class="card-img-top" src="{{ $p.image }}" alt="{{ $p.title }}">
                      </div>

                      <div class="card-body bg-transparent p-3">
                        <div class="pb-2 bg-transparent">
                          {{ range $p.badges }}
                            <span class="badge badge-secondary">{{ . }}</span>
                          {{ end }}
                        </div>

                        <h5 class="card-title bg-transparent mt-1">
                          {{ $p.title | truncate 50 }}
                        </h5>

                        <div class="card-text bg-transparent secondary-font">
                          {{ $p.content }}
                        </div>
                      </div>

                      {{ if or ($p.links) ($p.featured) }}
                        <div class="card-footer py-3">
                          {{ range $p.links }}
                            <span class="m-1 mx-2">
                              <a href="{{ .url }}" target="_blank" rel="noopener">
                                <i class="{{ .icon }}"></i>
                              </a>
                            </span>
                          {{ end }}

                          {{ if $p.featured }}
                            <span class="float-end">
                              <a class="btn btn-sm" href="{{ $p.featured.link }}" target="_blank">
                                {{ $p.featured.name }}
                              </a>
                            </span>
                          {{ end }}
                        </div>
                      {{ end }}
                    </div>
                  </div>

                {{ end }}

              </div>
            </div>
          {{ end }}

        </div>

        {{ if gt $total 1 }}
          <button class="carousel-control-prev" type="button" data-bs-target="#{{ $carouselId }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>

          <button class="carousel-control-next" type="button" data-bs-target="#{{ $carouselId }}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        {{ end }}
      </div>
    {{ end }}

  </div>
</section>
{{ end }}
